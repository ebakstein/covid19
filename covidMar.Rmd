---
title: "COVID-19 outbreak"
author: 
    Eduard Bakstein,
    eduard.bakstein@nudz.cz,
    http://bakstein.net,
    @edbakstein
date: "16.3.2020"
output:
  pdf_document: default
  word_document: default
---

```{r settings-packages, echo=F,warning=F,message=F}

# data handling + plots
library(tidyverse)
library(lubridate)
library(RColorBrewer)
library(knitr)

# web scraping
library(rvest)
library(jsonlite)


# epidemiology
# library(earlyR)
# library(EpiEstim)

# setup
knitr::opts_chunk$set(echo = F, warning = F,message = F,fig.width = 8,fig.height=5,cache=FALSE,dev="pdf")
tmp<-Sys.setlocale("LC_TIME", "C")


vars<-c('cases','incident','recovered','deaths')
colSc<-scale_colour_manual(
  values = brewer.pal(4,"Set1")[c(2,4,3,1)],
  labels = vars,
  aesthetics = c("colour", "fill"),
  name = 'variable'
)
 
# data-loading func
source('covidDataLoad.R')


```


## Intro

The aim is to do exploratory analyses of the COVID-19 cases in selected countries and see how the models evolve as new cases are reported. Can be used as a quick&dirty basis for your own analyses. Special focus given to Czech Rep., as this is my country of origin.

Source code (R markdown): https://github.com/ebakstein/covid19.git


**Resources:**

- https://rviews.rstudio.com/2020/03/05/covid-19-epidemiology-with-r/ (basis of this rmd and analysis)
- https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/

**Interesting models and remarks **

- https://blog.ephorie.de/epidemiology-how-contagious-is-novel-coronavirus-2019-ncov
- https://arxiv.org/pdf/2002.00418v1.pdf

**Data sources:**

- https://en.wikipedia.org/w/index.php?title=2020_coronavirus_outbreak_in_the_United_States&oldid=944107102
- https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series


## TO DO

 - modelling


## Load data
Using the Jons-Hopkins github repository to obtain current data, see
https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series (updated daily around 23:59 UTC)

```{r load-data}

covid<-covidLoadJHU()
 

```

Obtain data about population in each country by scraping the wikipedia page: 'https://en.wikipedia.org/wiki/List_of_countries_by_population_(United_Nations)'

```{r number-inhabit}

# attach population data from wikipedia
covid <- attachPopCounts(covid)

```


### Plot selected countries
```{r}
selCountries<-c('Czech Republic','Italy','Iran','Germany','Spain','France','Austria','Slovakia','Poland','South Korea','US')

# cases in selected countries
covid %>% filter(country %in% selCountries) %>%    ggplot(aes(x=Date,y=cases,col=country)) + geom_line() + ggtitle('cummulative cases - comparison') # + facet_wrap(~country) + theme(legend.position = 'none')

selCountries<- c(selCountries,'China')

```

Note: China number of cases too high to be plot on linear y axis with other countries

```{r}
covid %>% filter(country %in% selCountries) %>%  ggplot(aes(x=Date,y=cases,col=country)) + scale_y_continuous(trans='log10',breaks = 10^(0:5),labels = function(x) format(x, scientific = FALSE)) + geom_line() + ggtitle('cummulative cases - Log plot') # + facet_wrap(~country) + theme(legend.position = 'none')

```

Note: China added to the log plot


```{r per-capita}

covid %>% filter(country %in% selCountries) %>%  ggplot(aes(x=Date,y=casesPer1M,col=country)) + scale_y_continuous(trans='log10',labels = function(x) format(x, scientific = FALSE)) + geom_line() + ggtitle('cummulative cases per 1 mil. inhabitants - Log plot') # + facet_wrap(~country) + theme(legend.position = 'none')


```


### Cummulative stats for Individual selected countries
```{r plot-it}


for(cntr in selCountries){
  
  cdata<-covid %>% filter(country==cntr)
  
  outbreakDate<- min(cdata$Date[cdata$cases>0])
  
  plt <-  cdata[,1:6] %>% reshape2::melt(id=c('country','Date')) %>% mutate(variable=fct_relevel(variable,vars)) %>% ggplot(aes(x=Date,y=value,col=variable)) + geom_line() + colSc+ ggtitle(paste0('COVID19 - ',cntr)) + xlim(outbreakDate-days(3),NA)# + facet_wrap(~country) + theme(legend.position = 'none')
  
  
  print(plt)
}

```

### Latest number of cases across countries

According to the Johns-Hopkins data

```{r latest-numbers}

maxCounts <- covid %>% filter(country %in% selCountries) %>% group_by(country) %>% summarize(maxCount=max(cases), dateMax=Date[cases==max(cases)]) %>% ungroup()
  
kable(maxCounts)

```



## Plot and analyze Czech Rep.  - CZ data

obtain latest czech data from MZ / apify https://api.apify.com/v2/key-value-stores/K373S4uCFR9W1K8ei/records/LATEST?disableRedirect=true (parsed from https://onemocneni-aktualne.mzcr.cz/covid-19)

```{r cech-apify-json}

# load CZ covid data
tmp<-covidLoadCZ()
covidCZ <- tmp$covidCZ
covidCZregions <- tmp$covidCZregions
```



### exploratory plots: UZIS data

```{r plot-CZ}
covidCZ %>% mutate(propIncrease=propIncrease*100) %>% reshape2::melt(id=c('date')) %>% ggplot(aes(x=date,y=value,col=variable)) + geom_line() + ggtitle('COVID-19 Czech Republic: number of tests (UZIS data)')



covidCZ[,c('date','propIncrease','newCases')]  %>% mutate(propIncrease=propIncrease*100) %>% reshape2::melt(id=c('date')) %>% ggplot(aes(x=date,y=value,col=variable)) + geom_line() + xlim(as.Date('2020-02-26'),NA) + ggtitle('COVID-19 Czech Republic: number of tests (UZIS data)')

meanIncreaseCZ<-mean(covidCZ$propIncrease,na.rm=TRUE)

meanIncreaseCZl5<-mean(covidCZ$propIncrease[nrow(covidCZ)+(-4:0)],na.rm=TRUE)

outbreakCZ<-min(covidCZ$date[covidCZ$totalCases>0],na.rm=T)


```

first case in CZ: `r outbreakCZ`

Mean daily increase: `r format(100*meanIncreaseCZ,digits=3)`%

The diseased count doubles on average every `r format(1/log2(1+meanIncreaseCZ),digits=3)` days (`r format(24/log2(1+meanIncreaseCZ),digits=3)` hours).

Mean daily increase (last 5 days): `r format(100*meanIncreaseCZl5,digits=3)`%

The diseased count doubles on average every `r format(1/log2(1+meanIncreaseCZl5),digits=3)` days (`r format(24/log2(1+meanIncreaseCZl5),digits=3)` hours).


### CZ data table

```{r data table}

kable(covidCZ)

```



### exploratory plots: JHU data
```{r plot-CZ-jhu}
covidCZjhu <- covid %>% filter(country=='Czech Republic') 
covidCZjhu[,1:6] %>% reshape2::melt(id=c('country','Date')) %>% ggplot(aes(x=Date,y=value,col=variable)) + geom_line() +colSc + ggtitle('COVID-19 Czech Republic')


```

### compare JHU and ÃšZIS data

```{r compare-jhu-uzis}

combCZ <- merge(covidCZ,covidCZjhu,by.x='date',by.y='Date')

combCZ[,c('date','totalCases','newCases','cases','incident')] %>% rename(totalUZIS='totalCases',newUZIS='newCases',totalJHU='cases',newJHU='incident') %>% reshape2::melt(id=c('date')) %>% ggplot(aes(x=date,y=value,col=variable)) + xlim(as.Date('2020-02-28'),NA) + geom_line() + ggtitle('CovidCZ: JHU and UZIS data comparison')

```



### Epidemiological modelling - TBD

TBD according to: https://rviews.rstudio.com/2020/03/05/covid-19-epidemiology-with-r/
And https://timchurches.github.io/blog/posts/2020-03-10-modelling-the-effects-of-public-health-interventions-on-covid-19-transmission-part-1/



```{r epi-cz}


```

## Store data locally for further reff

```{r save-todays-data}

 write.csv(covid,paste0('covid',format(Sys.Date(),'%Y%m%d'),'.csv'))

```

