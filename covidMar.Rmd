---
title: "COVID-19 outbreak"
author: 
    Eduard Bakstein,
    eduard.bakstein@nudz.cz,
    http://bakstein.net,
    @edbakstein
date: "12.3.2020"
output:
  pdf_document: default
  word_document: default
---

```{r settings-packages, echo=F,warning=F,message=F}

# data handling + plots
library(tidyverse)
library(lubridate)
library(RColorBrewer)
library(knitr)

# web scraping
library(rvest)
library(jsonlite)


# epidemiology
# library(earlyR)
# library(EpiEstim)

# setup
knitr::opts_chunk$set(echo = F, warning = F,message = F,fig.width = 8,fig.height=5,cache=FALSE,dev="pdf")
tmp<-Sys.setlocale("LC_TIME", "C")


vars<-c('cases','incident','recovered','deaths')
colSc<-scale_colour_manual(
  values = brewer.pal(4,"Set1")[c(2,4,3,1)],
  labels = vars,
  aesthetics = c("colour", "fill"),
  name = 'variable'
)
 


```


## Intro

The aim is to do exploratory analyses of the COVID-19 cases in selected countries and see how the models evolve as new cases are reported. Can be used as a quick&dirty basis for your own analyses. Special focus given to Czech Rep., as this is my country of origin.

Source code (R markdown): https://github.com/ebakstein/covid19.git


**Resources:**

- https://rviews.rstudio.com/2020/03/05/covid-19-epidemiology-with-r/ (basis of this rmd and analysis)
- https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/

**Interesting models and remarks **

- https://blog.ephorie.de/epidemiology-how-contagious-is-novel-coronavirus-2019-ncov
- https://arxiv.org/pdf/2002.00418v1.pdf

**Data sources:**

- https://en.wikipedia.org/w/index.php?title=2020_coronavirus_outbreak_in_the_United_States&oldid=944107102
- https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series


## TO DO

 - modelling


## Load data
Using the Jons-Hopkins github repository to obtain current data, see
https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series (updated daily around 23:59 UTC)

```{r load-data}

## JONS-HOPKINS GITHUB

jhu_base_url<- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"

# jhu_conf_url <- paste("https://raw.githubusercontent.com/CSSEGISandData/", "COVID-19/master/csse_covid_19_data/", "csse_covid_19_time_series/", "time_series_19-covid-Confirmed.csv", sep = "")

jhu_conf_url <- paste0(jhu_base_url,"time_series_19-covid-Confirmed.csv")
jhu_deaths_url <- paste0(jhu_base_url,"time_series_19-covid-Deaths.csv")
jhu_recovered_url <- paste0(jhu_base_url,"time_series_19-covid-Recovered.csv")


covid_conf<-read_csv(jhu_conf_url) %>% rename(province = "Province/State", 
  country = "Country/Region") %>% pivot_longer(-c(province, 
  country, Lat, Long), names_to = "Date", values_to = "cumulative_cases") %>% arrange(province, Date) %>% group_by(country, Date) %>% summarise(cases=sum(cumulative_cases)) %>% mutate(Date=mdy(Date)) %>% arrange(country, Date) %>% group_by(country) %>% 
  mutate(incident = c(0, diff(cases))) 

covid_deaths<-read_csv(jhu_deaths_url) %>% rename(province = "Province/State", 
  country = "Country/Region") %>% pivot_longer(-c(province, 
  country, Lat, Long), names_to = "Date", values_to = "cumulative_cases") %>% arrange(province, Date) %>% group_by(country, Date) %>% summarise(deaths=sum(cumulative_cases)) %>% mutate(Date=mdy(Date)) %>% arrange(country, Date)

covid_recovered<-read_csv(jhu_recovered_url) %>% rename(province = "Province/State", 
  country = "Country/Region") %>% pivot_longer(-c(province, 
  country, Lat, Long), names_to = "Date", values_to = "cumulative_cases") %>% arrange(province, Date) %>% group_by(country, Date) %>% summarise(recovered=sum(cumulative_cases)) %>% mutate(Date=mdy(Date)) %>% arrange(country, Date)


# combine the 3 tables
covid<-left_join(covid_conf,covid_deaths,by=c('country','Date'))
covid<-left_join(covid,covid_recovered,by=c('country','Date')) 


# modify country names - to be consistent with wiki 
covid$country <- str_remove(covid$country,' \\(.+\\)') # remove country specifier (...republic of)
covid$country <- str_remove(covid$country,'Mainland ')
covid$country <- str_replace(covid$country,'Republic of Korea','South Korea')
covid$country <- str_replace(covid$country,'Korea, South','South Korea')
covid$country <- str_replace(covid$country,'Czechia','Czech Republic')



 

```

Obtain data about population in each country by scraping the wikipedia page: 'https://en.wikipedia.org/wiki/List_of_countries_by_population_(United_Nations)'

```{r number-inhabit}

## WIKI number of inhabitants

# get number of inhabitants: scrape from a wiki page 

# the URL of the wikipedia page to use is in wp_page_url
wp_page_url <- 'https://en.wikipedia.org/wiki/List_of_countries_by_population_(United_Nations)'
page_html <- read_html(wp_page_url)
population <- page_html %>% html_nodes("table") %>% .[[4]] %>% 
  html_table(fill = TRUE)

# clean up and convert to numbers
population <- population %>% rename(country='Country or area',population2018='Population(1 July 2018)',population='Population(1 July 2019)') %>% mutate(country=str_replace(country,'\\[.+\\]','')) %>% mutate(population=as.numeric(str_replace_all(population,'\\,','')))



covid<-left_join(covid,population[,c('country','population')], by='country')
covid$casesPer1M <- 10^6*covid$cases/covid$population
```

obtain latest czech data from MZ / apify https://api.apify.com/v2/key-value-stores/K373S4uCFR9W1K8ei/records/LATEST?disableRedirect=true (parsed from https://onemocneni-aktualne.mzcr.cz/covid-19)

```{r cech-apify-json}

apifyCZurl<-'https://api.apify.com/v2/key-value-stores/K373S4uCFR9W1K8ei/records/LATEST?disableRedirect=true'
czParsed <- fromJSON(txt=apifyCZurl)

tested<-czParsed$testedCases %>% mutate(value=as.numeric(value), date=as.Date(substr(date,1,10))) %>% rename(testedCases='value',Date='date')
totalCases<-czParsed$totalPositiveTests %>% mutate(value=as.numeric(value), date=as.Date(substr(date,1,10))) %>% rename(totalCases='value',Date='date')

# merge + compute incident cases
covidCZ<-merge(tested,totalCases,by='Date',all.x=T,all.y=T) %>% arrange(Date) %>% mutate(newCases=c(0,diff(totalCases)))
covidCZ$propIncrease<-c(0,covidCZ$newCases[2:nrow(covidCZ)]/covidCZ$totalCases[1:(nrow(covidCZ)-1)])
covidCZ[!is.na(covidCZ$propIncrease) & covidCZ$propIncrease==Inf,'propIncrease']<-1

```


### Plot selected countries
```{r}
selCountries<-c('Czech Republic','Italy','Iran','Germany','Spain','France','Austria','Slovakia','Poland','South Korea','US')

# cases in selected countries
covid %>% filter(country %in% selCountries) %>%    ggplot(aes(x=Date,y=cases,col=country)) + geom_line() + ggtitle('cummulative cases - comparison') # + facet_wrap(~country) + theme(legend.position = 'none')

selCountries<- c(selCountries,'China')

```

Note: China number of cases too high to be plot on linear y axis with other countries

```{r}
covid %>% filter(country %in% selCountries) %>%  ggplot(aes(x=Date,y=cases,col=country)) + scale_y_continuous(trans='log10',breaks = 10^(0:5),labels = function(x) format(x, scientific = FALSE)) + geom_line() + ggtitle('cummulative cases - Log plot') # + facet_wrap(~country) + theme(legend.position = 'none')

```

Note: China added to the log plot


```{r per-capita}

covid %>% filter(country %in% selCountries) %>%  ggplot(aes(x=Date,y=casesPer1M,col=country)) + scale_y_continuous(trans='log10',labels = function(x) format(x, scientific = FALSE)) + geom_line() + ggtitle('cummulative cases per 1 mil. inhabitants - Log plot') # + facet_wrap(~country) + theme(legend.position = 'none')


```


### Cummulative stats for Individual selected countries
```{r plot-it}


for(cntr in selCountries){
  
  cdata<-covid %>% filter(country==cntr)
  
  outbreakDate<- min(cdata$Date[cdata$cases>0])
  
  plt <-  cdata[,1:6] %>% reshape2::melt(id=c('country','Date')) %>% mutate(variable=fct_relevel(variable,vars)) %>% ggplot(aes(x=Date,y=value,col=variable)) + geom_line() + colSc+ ggtitle(paste0('COVID19 - ',cntr)) + xlim(outbreakDate-days(3),NA)# + facet_wrap(~country) + theme(legend.position = 'none')
  
  
  print(plt)
}

```

### Latest number of cases across countries

```{r latest-numbers}

maxCounts <- covid %>% filter(country %in% selCountries) %>% group_by(country) %>% summarize(maxCount=max(cases), dateMax=Date[cases==max(cases)]) %>% ungroup()
  
kable(maxCounts)

```



## Plot and analyze Czech Rep.


### exploratory plots: UZIS data

```{r plot-CZ}
covidCZ %>% mutate(propIncrease=propIncrease*100) %>% reshape2::melt(id=c('Date')) %>% ggplot(aes(x=Date,y=value,col=variable)) + geom_line() + ggtitle('COVID-19 Czech Republic: number of tests (UZIS data)')



covidCZ[,c('Date','propIncrease','newCases')]  %>% mutate(propIncrease=propIncrease*100) %>% reshape2::melt(id=c('Date')) %>% ggplot(aes(x=Date,y=value,col=variable)) + geom_line() + xlim(as.Date('2020-02-26'),NA) + ggtitle('COVID-19 Czech Republic: number of tests (UZIS data)')

meanIncreaseCZ<-mean(covidCZ$propIncrease,na.rm=TRUE)

meanIncreaseCZl5<-mean(covidCZ$propIncrease[nrow(covidCZ)+(-4:0)],na.rm=TRUE)

outbreakCZ<-min(covidCZ$Date[covidCZ$totalCases>0],na.rm=T)


```

first case in CZ: `r outbreakCZ`

Mean daily increase: `r format(100*meanIncreaseCZ,digits=3)`%

The diseased count doubles on average every `r format(1/log2(1+meanIncreaseCZ),digits=4)` days.

Mean daily increase (last 5 days): `r format(100*meanIncreaseCZl5,digits=3)`%

The diseased count doubles on average every `r format(1/log2(1+meanIncreaseCZl5),digits=4)` days.


### CZ data table

```{r data table}

kable(covidCZ)

```



### exploratory plots: JHU data
```{r plot-CZ-jhu}
covidCZjhu <- covid %>% filter(country=='Czech Republic') 
covidCZjhu[,1:6] %>% reshape2::melt(id=c('country','Date')) %>% ggplot(aes(x=Date,y=value,col=variable)) + geom_line() +colSc + ggtitle('COVID-19 Czech Republic')


```

### compare JHU and ÚZIS data

```{r compare-jhu-uzis}

combCZ <- merge(covidCZ,covidCZjhu,by='Date')

combCZ[,c('Date','totalCases','newCases','cases','incident')] %>% rename(totalUZIS='totalCases',newUZIS='newCases',totalJHU='cases',newJHU='incident') %>% reshape2::melt(id=c('Date')) %>% ggplot(aes(x=Date,y=value,col=variable)) + xlim(as.Date('2020-02-28'),NA) + geom_line() + ggtitle('CovidCZ: JHU and UZIS data comparison')

```



### Epidemiological modelling - TBD

TBD according to: https://rviews.rstudio.com/2020/03/05/covid-19-epidemiology-with-r/
And https://timchurches.github.io/blog/posts/2020-03-10-modelling-the-effects-of-public-health-interventions-on-covid-19-transmission-part-1/



```{r epi-cz}


```

## Store data locally for further reff

```{r save-todays-data}

 write.csv(covid,paste0('covid',format(Sys.Date(),'%Y%m%d'),'.csv'))

```

